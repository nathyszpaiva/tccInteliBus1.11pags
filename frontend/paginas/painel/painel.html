<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>| TELA DO MOTORISTA</title>

    <script>
        // Verifica se o usu√°rio tem o papel de 'painel' no LocalStorage
        const userRole = localStorage.getItem('userRole');

        // Se o papel n√£o for 'painel', redireciona imediatamente
        if (userRole !== 'painel') {
            console.error("Acesso negado! Voc√™ precisa ser um Painel/Motorista para acessar esta tela.");
            // Usando caminho absoluto para evitar o SyntaxError e garantir que a URL seja v√°lida.
            window.location.replace("/frontend/paginas/passageiro/login.html");
        }

        // Obter o ID do Painel (chave essencial para identificar a origem)
        window.painelId = localStorage.getItem('painelId') || 'PAINEL_DESCONHECIDO';
    </script>

    <link rel="stylesheet" href="/frontend/css/style_painel.css">
    <link rel="icon" type="image/png" href="/frontend/assets/icones/painel/icon_janela.png">

    <!-- Estilo B√°sico para o Modal de Feedback (Substitui o alert()) -->
    <style>
        .feedback-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            /* Inicia escondido */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .feedback-content {
            background-color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>

<body>
    <script type="module">
        // Importa as fun√ß√µes necess√°rias, incluindo as de Autentica√ß√£o
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // ==========================================================
        // üöÄ CORRE√á√ÉO CR√çTICA: CONFIGURA√á√ÉO HARDCODED COMO FALLBACK
        // ==========================================================

        const HARDCODED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC1HmcMKzovu2LM7RmxBq5f6zsun76YZIs",
            authDomain: "intelibustcc.firebaseapp.com",
            projectId: "intelibustcc",
            storageBucket: "intelibustcc.firebasestorage.app",
            messagingSenderId: "212399344112",
            appId: "1:212399344112:web:03dbb7d367f5542dc83535",
            measurementId: "G-RWN8EMEW63"
        };

        // 1. Tenta carregar a configura√ß√£o do ambiente
        let firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 2. Se a configura√ß√£o do ambiente estiver vazia, usa a hardcoded
        if (Object.keys(firebaseConfig).length === 0) {
            firebaseConfig = HARDCODED_FIREBASE_CONFIG;
            console.warn("DEBUG: Configura√ß√£o do Firebase n√£o encontrada no ambiente. Usando configura√ß√£o de fallback hardcoded.");
        }

        // 3. Obt√©m o appId
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId;


        // Vari√°veis globais do Firebase
        window.db = null;
        window.auth = null;
        window.COLLECTION_NOTIFICACOES_PATH = null;
        window.isAuthReady = false;

        // Inicializa Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            window.COLLECTION_NOTIFICACOES_PATH = `artifacts/${appId}/public/data/notificacoes`;
            setLogLevel('silent'); // Para ver logs detalhados

            // L√≥gica de Autentica√ß√£o
            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                        console.log("Firebase Auth: Logado via Custom Token.");
                    } else {
                        // Faz login an√¥nimo se o token n√£o estiver dispon√≠vel
                        await signInAnonymously(window.auth);
                        console.log("Firebase Auth: Logado Anonimamente (fallback).");
                    }
                } catch (error) {
                    console.error("Erro no processo de autentica√ß√£o:", error);
                } finally {
                    window.isAuthReady = true;
                    console.log("Autentica√ß√£o Firebase Pronta.");
                }
            }

            authenticate();
        } else {
            console.error("Configura√ß√£o do Firebase n√£o dispon√≠vel. Opera√ß√µes de DB ser√£o ignoradas.");
            window.isAuthReady = true;
        }

    </script>

    <!-- Modal de Feedback (Substitui o alert()) -->
    <div id="feedbackModal" class="feedback-modal">
        <div class="feedback-content" id="feedbackMessage"></div>
    </div>

    <div class="tablet">
        <div class="sidebar">
            <div class="btn-wrapper">
                <button class="btn-round bluesky" onclick="window.sendNotification('Mudan√ßa de Rota')">
                    <img src="/frontend/assets/icones/painel/icon_rota.png" alt="IconButtomBlueSky">
                </button>
            </div>
            <div class="btn-wrapper">
                <button class="btn-round greenlemon" onclick="window.sendNotification('Atraso')">
                    <img src="/frontend/assets/icones/painel/icon_atraso.png" alt="IconButtomGreenLemon">
                </button>
            </div>
            <div class="btn-wrapper">
                <button class="btn-round yellow" onclick="window.sendNotification('Superlota√ß√£o')">
                    <img src="/frontend/assets/icones/painel/icon_lotacao.png" alt="IconButtomYellow">
                </button>
            </div>
            <div class="btn-wrapper">
                <button class="btn-round coral" onclick="window.sendNotification('Emerg√™ncia')">
                    <img src="/frontend/assets/icones/painel/icon_emergencia.png" alt="IconButtomCoral">
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="top-bar">
                <span id="current-date"></span>
                <span id="timer"></span>
                <span>Campinas, SP | BR</span>
            </div>

            <div class="divider"></div>
            <div class="counter-info up">‚ñ≤ 2</div>
            <div class="passenger-count" id="count">40</div>
            <div class="counter-info down">‚ñº 9</div>
        </div>
    </div>

    <script>
        // Fun√ß√£o para mostrar o modal de feedback
        function showFeedback(message, color = '#333') {
            const modal = document.getElementById('feedbackModal');
            const messageDiv = document.getElementById('feedbackMessage');
            messageDiv.textContent = message;
            messageDiv.style.color = color;
            modal.style.display = 'flex';

            // Esconde o modal ap√≥s 3 segundos
            setTimeout(() => {
                modal.style.display = 'none';
            }, 3000);
        }

        // Simula a busca da Linha (Em um app real, buscar√≠amos em 'paineis' ou 'linhas')
        function getLinhaInfo(painelId) {
            // PLaceholder para simular que o Painel "sabe" qual linha ele opera
            return {
                id: '123', // ID da Linha (Exemplo)
                nome: 'Centro - Taquaral'
            };
        }

        // L√≥gica para Salvar Notifica√ß√£o no Firestore
        window.sendNotification = async function (type) {

            // 1. VERIFICA SE O DB EST√Å PRONTO E CONECTADO
            if (!window.isAuthReady) {
                // A autentica√ß√£o est√° sendo processada, aguarde
                showFeedback('‚è≥ Aguardando autentica√ß√£o...', 'gray');
                return;
            }
            if (!window.db) {
                // O DB n√£o foi inicializado porque a configura√ß√£o estava ausente
                showFeedback('‚ùå Sistema de DB n√£o pronto. Configura√ß√£o ausente.', 'red');
                return;
            }


            const db = window.db;
            const COLLECTION_NOTIFICACOES_PATH = window.COLLECTION_NOTIFICACOES_PATH;
            const painelId = window.painelId;
            const linhaInfo = getLinhaInfo(painelId);

            const now = new Date();
            const dataHora = now.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'medium', timeZone: 'America/Sao_Paulo' });

            // Constr√≥i a mensagem personalizada
            let titulo, descricao;

            switch (type) {
                case 'Mudan√ßa de Rota':
                    titulo = `‚ö†Ô∏è Mudan√ßa de Rota na Linha ${linhaInfo.id}`;
                    descricao = `Houve uma altera√ß√£o na rota no dia ${dataHora}.`;
                    break;
                case 'Superlota√ß√£o':
                    titulo = `üö® Superlota√ß√£o - Linha ${linhaInfo.id}`;
                    descricao = `Superlota√ß√£o registrada em ${dataHora}.`;
                    break;
                case 'Emerg√™ncia':
                    titulo = `üöë Emerg√™ncia na Linha ${linhaInfo.id}`;
                    descricao = `Emerg√™ncia reportada em ${dataHora}. Acompanhe as atualiza√ß√µes.`;
                    break;
                case 'Atraso':
                    titulo = `‚è∞ Atraso - Linha ${linhaInfo.id}`;
                    descricao = `O √¥nibus est√° com atraso inesperado. Informa√ß√µes atualizadas em ${dataHora}.`;
                    break;
                default:
                    titulo = `Notifica√ß√£o Padr√£o - Linha ${linhaInfo.id}`;
                    descricao = `Evento gen√©rico na Linha ${linhaInfo.nome} em ${dataHora}.`;
            }

            try {
                // O import √© feito aqui novamente para garantir o acesso ao m√≥dulo
                const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js");

                await addDoc(collection(db, COLLECTION_NOTIFICACOES_PATH), {
                    painelId: painelId,
                    linhaId: linhaInfo.id,
                    tipo: type,
                    titulo: titulo,
                    descricao: descricao,
                    timestamp: now.getTime(), // Salva em milissegundos para ordena√ß√£o
                    dataHora: dataHora,
                    lida: false
                });

                showFeedback(`‚úÖ ${type} enviado!`, 'green');

            } catch (e) {
                console.error("Erro ao enviar notifica√ß√£o:", e);
                // O erro de permiss√£o (se ocorrer) ser√° capturado aqui
                showFeedback(`‚ùå Erro ao enviar: ${e.message.includes('permission') ? 'Permiss√£o Negada (Auth)' : e.message}`, 'red');
            }
        }

        // HORA E DATA EM TEMPO REAL (mantidas)
        function updateRealTime() {
            const now = new Date();
            const options = {
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false,
                timeZone: 'America/Sao_Paulo'
            };
            const timeString = new Intl.DateTimeFormat('pt-BR', options).format(now);
            document.getElementById('timer').innerText = timeString;
        }

        // exibi√ß√£o da data (mantida)
        function updateDate() {
            const now = new Date();
            const options = {
                weekday: 'short', year: 'numeric', month: 'short', day: 'numeric',
                timeZone: 'America/Sao_Paulo'
            };
            const dateString = new Intl.DateTimeFormat('pt-BR', options).format(now);
            document.getElementById('current-date').innerText = dateString;
        }
        // atualiza a hora e data a cada segundo
        setInterval(updateRealTime, 1000);
        setInterval(updateDate, 1000);

        // n√£o esperar 1 segundo
        updateRealTime();
        updateDate();
    </script>

</body>

</html>